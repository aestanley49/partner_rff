---
title: "salafsky_network"
author: "Annabelle"
date: "February 24, 2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r, include = FALSE, echo = FALSE}
## setup the file structure so that this markdown document is in the main project folder along with the other folders noted below

DataSource <- "./data" # input raw dataset goes here
output.dir <-"./output" # output dataset writes to here
functions.dir <- "./functions" # directory for functions 

source(file.path(functions.dir,'cleaning_salafsky.R')) # any functions that are called up by this markdown document need to be sourced here

## general functions that need to be read in. I like to put them at the top so they are easier to deal with when they change version (inevitable)

library(tidyverse)
library(skimr)
library(knitr)
library(janitor)
```

# Methods

For XXX species that have been precluded from listing due to conservation actions:

We collected data from Federal Register documents, recovery plans, and YYY (need description of data sources) on 
  -	How many partners were involved in the recovery 
  - Who the partners were, (subset)
  - What the partners were doing (subset of subset) 
     -	Categorized to Salafsky action headings + a few categories (?)

```{r, echo = FALSE, include = FALSE}
##this chunk is used to format the data set. 
## can use it to make settings etc.

CleanData <- read.csv(paste0(DataSource,"/codesalafsky.csv"), stringsAsFactors = FALSE) #removing end piece doesn't change it to factor (just back to character)
##change to tibble if needed
?as_tibble
newdata <- CleanData %>%  as_tibble() ##this is a tibble 

## ideally, the raw dataset gets noted here, then you do any data manipulations in code and generate a useable dataset for later manipulations. I didn't have the dataset you called up in your code, so I put this one in to demonstrate. I would like it if we coudl get from this dataset in code "copyoflatestsummerwork_Partnerships_Precluded_species_recovered.xlsx"

code <- cleaning_salafsky(newdata)
##function includes 1s and 0s? 


#function not running
#code <- CleanData2
code <- CleanData

head(as.numeric(CleanData2[,c(10:11)]))

code2 <- read.csv(paste0(DataSource,"/tableofpartnersandactions.csv"), stringsAsFactors = FALSE, header = TRUE) #this is the same as PartnersData.csv now - basically csv that gets produced during cleaning_salafsky function. Only difference is tableofpartnersandactions.csv is saved on Annabelle's local computer. 

class(code$funding)
summary(code2) #now should be numeric 



tdata <- read.csv(paste0(DataSource,"/Updated_variables.csv"), stringsAsFactors = FALSE)
tdata <- tdata %>%  as_tibble() #now can use stringr packages 
tdata <- tdata %>%  ##cleaning/reformating colunm names --> default is lower_case_snake
                  clean_names()
```

Summary Stats
- # species
- # docs/agreements? 

```{r}
unique(code$Common.name) ##41
unique(code$Scientific.name) ##41
    ##41 of original 90 species represented here 

#count by two columns? 
#unique(df[c("yad", "per")])
??count.unique
require(vctrs)
vec_count(code[c("agreement.number", "Common.name")])
  ##51 different agreements 
```

# partners 
  - need to address: 
    - strings sperated by ","
    - spelling and Capitolization errors 
    - new notation like 'all parties' or 'private landowners' 
```{r}
##subset based on type of partner so don't have any multi (Should exclude any multi partner strings)
##then count unique 

nom <- code[-which(code$type.of.partners == "M"),]
#View(nom)
unique(nom$partner.in.agreement)
  #139 

#had 139 before but now only 95?

```


```{r}
skim(code, partner.in.agreement)
```


row and col sums 
```{r}
class(as.numeric(code$funding))
class(code$funding)
class(code2$funding)
num <- as.numeric(code[-c(1:9)])

as.numeric(unlist(code$X1..Land.Water.Management))
as.numeric(unlist(code$X2..Species.Management))

rowSums(as.numeric(code2[,c(10:11)]))

colSums(code[,-c(1:9)])

is.numeric(code$X10..Institutional.Development)


is.tibble(code2)

df <- as_tibble(code)
df <- df %>% convert(num(funding))
dat[, c(3,6:15,37)] <- sapply(dat[, c(3,6:15,37)], as.numeric)

### this works
code2[,c(11:21)] <- sapply(code2[ ,c(11:21)], as.numeric)
class(code2$X6..Conservation.Design.and.Planning)

rowSums((code2[,c(11:21)]))

colSums(code2[,c(11:21)])


```


histograms
```{r}
plot(code$X1..Land.Water.Management)

rsum <- (rowSums(code2[,c(11:21)]))

ggplot(data = code2, mapping = aes(x=rsum)) + geom_bar()

csum <- (colSums(code2[,c(11:21)]))

plot(csum)
#ggplot(code2) + geom_point(aes(x=csum, y=csum)) weird error message 

csum

```
For each action – how many times is it applied total (counting each speciesXpartner separately)
- information contained in csum output 


count how many agreeements there are - 
```{r}
#start with tidydataset
is.tibble(df)
tidycode <- df #new vector so can start over
tidycode  %>% pivot_wider(names_from = agreement.number, values_from = funding) #getting error column 15 must be named
library(janitor)
work <- tidycode %>% get_dupes(agreement.number) %>% filter(Scientific.name) ## 203 agreements? x not removing redundant scientific names 



```


# Part 2
Loaded in the data to new vector 
```{r}
alldf <- CleanData2 #final output in the cleaning_salafsky function 
alldf <- as_tibble(alldf)
alldf <- code2 #in previous chunk changed action cat to numeric 
```


# Species

For each species: how many different actions are applied (and how many of each action).
```{r}
# loop 
  #filter by scientific names
  # For each unique value 
  # column sum
  #table output of each? (??)
colnames(alldf[,c(10:20)])

species <- select(alldf, Scientific.name, X1..Land.Water.Management ,X2..Species.Management, X3..Awareness.raising,X4..law.enforcement.and.prosecution,X5..livelihood..economic.and.moral.incentrives, X6..Conservation.Design.and.Planning,X7..Legal.and.Policy.frameworks,X8..Research.and.monitoring, X9..Education.and.Training, X10..Institutional.Development,funding) #selecting all relevant columns

#Make work as numeric
### this works


eachsp <- species %>% group_by(Scientific.name) %>% summarise_each(funs(sum)) 

eachsp #for each species, summed actions done by each partner
kable(eachsp) #prints out weird 


#get count of total number of actions for each 
onesandzeros <- eachsp %>% mutate_if(is.numeric, ~1 * (. > 0)) #changed all values back to ones and zeros
totalno <- onesandzeros %>% mutate(actionsum = rowSums(onesandzeros[,c(2:12)])) #added column "actionsum" that took the row sums for each species to give count of how many actions each species receives 
kable(totalno) #this prints out weird
totalno
```

How many partners  does each species have and do partners conduct the same or different actions from each other
    - Can find number of partners but unsure how to answer second part of Q
      - "Do partners conduct same or different actions.." for same partner working on each species or across different species? 
```{r}
nopartners <- (alldf %>% group_by(Scientific.name)   #selecting  each species
%>% distinct(partner.in.agreement)    #count how many partners are distinct 
%>% summarise(n()))                   # Count the number of distinct 

kable(nopartners)


#part two of question 
```

How many threats does each species face
   - information found in regression prep script 
```{r}
####***********LOAD ME

allspindf <- eachsp
new <- tdata #need to join with tdata (renamed here)
new$scientific_name
#select relevant columns
tthreats <- select(new, scientific_name, hab_x_x:threats_addressed_by_conservation_x_x)

tthreats$scientific_name
#need to join with tdata 
#to do so need to change col name so match 

tthreats <- rename(tthreats, Sciname = scientific_name)
allspindf <- rename(allspindf, Sciname = Scientific.name)

threats <- left_join(allspindf, tthreats, join_by = Sciname)

#total number of threats for each sp
threats$total_x_x
#(missing info for 4 sp)

```



# Graphs 
  (Section two in ppt slide no 4)

For each action – how many species receive that action
```{r}
# take column sum of onesandzeros dataset created above
actionsums <- colSums(onesandzeros[,c(2:12)]) #add all species for which that action happened

kable(actionsums)

plot(actionsums)

ggplot(actionsums) + geom_count(mapping = aes())

```

For each action – how many times is it applied total (counting each speciesXpartner separately)
- information contained in csum output 
```{r}
## for all speciesXpartners csum but this includes some repetition ("partners" which are actually multiple partners working on same action)
kable(csum)

#check csum
check <- colSums(eachsp[,c(2:12)])
#yes get the same values 

#redo csum calculation and take out = M

##
noM <- code2[-which(code2$type.of.partners == "M"),]
newcsum <- (colSums(noM[,c(11:21)]))

plot(newcsum)


```

For each action – how many partners apply that action to at least 1 species
```{r}
partners <- select(alldf, partner.in.agreement, Scientific.name, X1..Land.Water.Management ,X2..Species.Management, X3..Awareness.raising,X4..law.enforcement.and.prosecution,X5..livelihood..economic.and.moral.incentrives, X6..Conservation.Design.and.Planning,X7..Legal.and.Policy.frameworks,X8..Research.and.monitoring, X9..Education.and.Training, X10..Institutional.Development,funding) #selecting all relevant columns

class(partners$funding)

#so summarise will only accept 1 value per group so going to try and do for each group 
#there is definetly a more elegant/better way to do this but this works
x1 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(3)])) #84
x2 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(4)])) #45
x3 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(5)])) #13
x4 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(6)])) #4
x5 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(7)])) #5   
x6 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(8)])) #68
x7 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(9)])) #38
x8 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(10)])) #72
x9 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(11)])) #26
x10 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(12)])) #75
x11 <- partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,c(13)])) #41
## (for each row, value is to the right)

partnerapptosp <- c(x1, x2, x3, x4,x5, x6,x7,x8,x9,x10,x11)

col_list <- partners[,c(3:13)]
for(coln in col_list){
  partners %>% group_by(partner.in.agreement) %>% summarise(sum(partners[,coln]))
} ## Got error 

#*#*#*#*#  find nicer way to present this information == put in table 
```





# Network analysis
*** New idea - replace 1s in each column for actions with column name, then would be able to set up the "to/from" lists*#*#*#
actions 
nodes: actions
Node size: number of times that action is applied
Edge: number of partnerships that apply both types of actions

```{r}
actions <- list(c("Land.Water.Management", "Species.Management","Awareness.raising","law.enforcement.and.prosecution","livelihood..economic.and.moral.incentrives","Conservation.Design.and.Planning","Legal.and.Policy.frameworks","Research.and.monitoring","Education.and.Training","Institutional.Development","funding"))

#nodesize - no times action is applied by all partners
nodesize <- newcsum 
## actually need to refine this so not including ones with multiple species and partners 

eachsp #for each species, summed actions done by each partner
totalno # total no of actions for each species 
nopartners # number of partners for each species 
actionsums # number of species who recieve the action (for each action)
csum #number of times action is applied for all speciesXpartnet
newcsum # same as above but multipartner strings removed 


#want to set up matrix where column names and rows are nodes (different actions)
# diagonal would be nodesize 
# all other cells would make up the edges between nodes
  # to get this would write loop where works column by 

mat <- matrix(0L, nrow = 11, ncol = 11, dimnames = actions)
diag(mat) <- newcsum
mat


## Didn't work bc not same length 
netset <- noM[,c(11:21)]
tt <- t(netset)



new <- as.matrix(netset) %*% as.matrix(tt)
```


threats 
Nodes: threats
Size of nodes: number of species incurring that threat
Edges – number of species experiencing both threats

```{r}

```

